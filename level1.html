<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Protocol 50 — Level 1</title>
  <style>
    :root {
      --bg:#0b0f14; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --ok:#22c55e; --bad:#ef4444;
      --green:#00ff66;
    }

    /* Background + layout */
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 70% 0%, #111827 0%, var(--bg) 55%);
      color:var(--green);
      overflow-x:hidden;
    }

    /* Matrix canvas */
    canvas#rain{
      position:fixed; inset:0;
      width:100%; height:100%;
      z-index:0;
      opacity:.55;
      pointer-events:none;
    }

    /* CRT overlay (scanlines + flicker) */
    body.crt::before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
              repeating-linear-gradient(
                      to bottom,
                      rgba(0,0,0,0) 0px,
                      rgba(0,0,0,0) 2px,
                      rgba(0,0,0,.18) 3px
              );
      mix-blend-mode:multiply;
      opacity:.28;
      z-index:2;
    }
    body.crt::after{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background:
              radial-gradient(ellipse at center, rgba(0,0,0,0) 45%, rgba(0,0,0,.72) 100%),
              linear-gradient(to bottom, rgba(0,0,0,.22), rgba(0,0,0,.48));
      z-index:2;
      animation: flicker 4.2s infinite;
    }
    @keyframes flicker{
      0%,100%{opacity:1}
      41%{opacity:.92}
      42%{opacity:1}
      74%{opacity:.95}
      75%{opacity:1}
      88%{opacity:.9}
      89%{opacity:1}
    }

    /* Flash overlays */
    .flash{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:0;
      z-index:3;
    }
    .flash.bad{ background: rgba(255,0,0,.18); }
    .flash.ok{ background: rgba(0,255,102,.12); }
    .flash.on{ animation: flashanim .45s ease-in-out 1; }
    @keyframes flashanim{
      0%{opacity:0}
      12%{opacity:1}
      45%{opacity:.35}
      75%{opacity:.85}
      100%{opacity:0}
    }

    /* Content container */
    .wrap{ max-width:980px; margin:0 auto; padding:24px 16px 40px; position:relative; z-index:4; }
    .top{ display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
    .title{ font-size:22px; font-weight:800; letter-spacing:.3px; color:var(--green);}
    .sub{ color:var(--muted); margin-top:6px; line-height:1.4; }
    .pill{ background:rgba(148,163,184,.12); border:1px solid rgba(148,163,184,.22); padding:8px 10px; border-radius:999px; color:var(--muted); font-size:13px; }

    .panel{
      margin-top:16px;
      background:rgba(17,24,39,.65);
      border:1px solid rgba(148,163,184,.18);
      border-radius:16px;
      padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
    }

    .hud{ display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .hud b{ font-size:14px; }
    .sig{ color:rgba(148,163,184,.7); font-size:12px; margin-top:12px; }

    .progress{ height:10px; background:rgba(148,163,184,.12); border-radius:999px; overflow:hidden; width:240px; border:1px solid rgba(148,163,184,.18); }
    .bar{ height:100%; width:0%; background:rgba(229,231,235,.8); transition:width .25s ease; }

    .grid{ margin-top:14px; display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
    @media (max-width:780px){ .grid{ grid-template-columns:repeat(3,1fr);} }
    @media (max-width:520px){ .grid{ grid-template-columns:repeat(2,1fr);} .progress{ width:100%; } }

    button.card{
      appearance:none;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.35);
      border-radius:14px;
      padding:10px;
      cursor:pointer;
      transition:transform .06s ease, border-color .2s ease, background .2s ease, box-shadow .2s ease;
      display:flex; align-items:center; justify-content:center;
      min-height:120px;
    }
    button.card:hover{
      transform:translateY(-1px);
      border-color:rgba(229,231,235,.35);
      background:rgba(2,6,23,.5);
      box-shadow: 0 0 0 1px rgba(0,255,102,.08) inset;
    }
    button.card:disabled{ cursor:not-allowed; opacity:.7; transform:none; }

    .msg{ margin-top:14px; min-height:54px; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    .toast{ padding:10px 12px; border-radius:12px; border:1px solid rgba(148,163,184,.18); background:rgba(2,6,23,.35); color:var(--muted); }
    .toast.ok{ border-color:rgba(34,197,94,.45); color:#bbf7d0; }
    .toast.bad{ border-color:rgba(239,68,68,.45); color:#fecaca; }
    .letterbox{ font-size:18px; font-weight:900; letter-spacing:6px; }
    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .btn{
      border:1px solid rgba(148,163,184,.18);
      background:rgba(148,163,184,.10);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
    }
    .btn:hover{ border-color:rgba(229,231,235,.3); }
    .hidden{ display:none; }

    svg{ width:100%; max-width:120px; height:auto; }

    /* Start overlay to unlock audio */
    .startOverlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.72);
      z-index:20;
      backdrop-filter: blur(4px);
    }
    .startCard{
      width:min(520px, 92vw);
      border-radius:16px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(17,24,39,.70);
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
      text-align:center;
    }
    .startCard h2{
      margin:0 0 6px;
      font-size:16px;
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    .startCard p{
      margin:0 0 14px;
      color:rgba(148,163,184,.85);
      font-size:13px;
      line-height:1.4;
    }
    .startBtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:12px 16px;
      border-radius:12px;
      border:1px solid rgba(0,255,102,.45);
      background: rgba(0,255,102,.08);
      color: #d9ffe9;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.10em;
    }
    .startBtn:hover{ background: rgba(0,255,102,.12); border-color: rgba(0,255,102,.7); }

    /* ====== PROTOCOL GREEN THEME ====== */
    body{ color: var(--green); }

    .title{ color: var(--green); }
    .sub, .pill, .sig{ color: rgba(0,255,102,.70); }

    .panel{
      border-color: rgba(0,255,102,.22);
      box-shadow: 0 10px 30px rgba(0,0,0,.35), 0 0 18px rgba(0,255,102,.12);
    }

    .pill{
      background: rgba(0,255,102,.08);
      border-color: rgba(0,255,102,.22);
    }

    .toast{
      border-color: rgba(0,255,102,.18);
      background: rgba(0,255,102,.04);
      color: rgba(0,255,102,.75);
    }
    .toast.ok{
      border-color: rgba(0,255,102,.45);
      color: rgba(0,255,102,.95);
    }
    .toast.bad{
      border-color: rgba(239,68,68,.55);
      color: #fecaca;
    }

    .progress{
      background: rgba(0,255,102,.08);
      border-color: rgba(0,255,102,.18);
    }
    .bar{
      background: rgba(0,255,102,.75);
    }

    button.card{
      border-color: rgba(0,255,102,.18);
      background: rgba(0,0,0,.25);
    }
    button.card:hover{
      border-color: rgba(0,255,102,.55);
      background: rgba(0,255,102,.06);
      box-shadow: 0 0 0 1px rgba(0,255,102,.14) inset, 0 0 18px rgba(0,255,102,.08);
    }

    .btn{
      border-color: rgba(0,255,102,.22);
      background: rgba(0,255,102,.08);
      color: rgba(0,255,102,.95);
    }
    .btn:hover{
      border-color: rgba(0,255,102,.55);
      background: rgba(0,255,102,.12);
    }

    /* Start overlay styling in green */
    .startCard{
      border-color: rgba(0,255,102,.18);
      background: rgba(0,0,0,.55);
    }
    .startCard h2{ color: rgba(0,255,102,.95); }
    .startCard p{ color: rgba(0,255,102,.70); }
    .startBtn{
      border-color: rgba(0,255,102,.55);
      background: rgba(0,255,102,.10);
      color: rgba(0,255,102,.95);
    }
    .startBtn:hover{
      border-color: rgba(0,255,102,.85);
      background: rgba(0,255,102,.14);
    }

  </style>
</head>

<body class="crt">
<canvas id="rain"></canvas>
<div id="flashBad" class="flash bad"></div>
<div id="flashOk" class="flash ok"></div>

<!-- Audio unlock -->
<div id="startOverlay" class="startOverlay">
  <div class="startCard">
    <h2>LEVEL 1 ACCESS</h2>
    <p>Druk op START om het systeem te initialiseren (audio + display).</p>
    <button id="startBtn" class="startBtn">START</button>
  </div>
</div>

<div class="wrap">
  <div class="top">
    <div>
      <div class="title">PROTOCOL 50 — Level 1: Identificatie</div>
      <div class="sub">
        Kies per ronde het <b>menselijk onmogelijke</b> silhouet. Bij een correct antwoord krijg je de volgende letter.
      </div>
    </div>
    <div class="pill" id="roundPill">Ronde 1/5</div>
  </div>

  <div class="panel">
    <div class="hud">
      <div>
        <div><b>Doel:</b> ontgrendel de codenaam</div>
        <div class="sig">Tip: kijk naar gewrichten, zwaartepunt en anatomie.</div>
      </div>
      <div class="progress" aria-label="Voortgang"><div class="bar" id="bar"></div></div>
    </div>

    <div class="grid" id="grid" role="list"></div>

    <div class="msg">
      <div class="toast" id="toast">Selecteer het onmogelijk silhouet.</div>
      <div class="controls">
        <div class="letterbox" id="letters">_ _ _ _ _</div>
        <button class="btn hidden" id="restart">Opnieuw</button>
      </div>
    </div>
  </div>
</div>

<script>
  (() => {
    // -----------------------------
    // Matrix rain background
    // -----------------------------
    const canvas = document.getElementById("rain");
    const ctx = canvas.getContext("2d", { alpha: true });
    const charset = "アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヲン0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let w,h,columns,drops,fontSize;
    let running = false;
    let intensity = 0.10; // trails
    let speed = 1;

    function resize(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      w = canvas.width = Math.floor(window.innerWidth * dpr);
      h = canvas.height = Math.floor(window.innerHeight * dpr);
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
      fontSize = Math.max(14, Math.floor(18 * dpr));
      columns = Math.floor(w / fontSize);
      drops = new Array(columns).fill(0).map(() => Math.floor(Math.random() * (h / fontSize)));
      ctx.font = `${fontSize}px ui-monospace, monospace`;
      ctx.textBaseline = "top";
    }
    window.addEventListener("resize", resize, { passive:true });
    resize();

    function draw(){
      if(!running) return;
      ctx.fillStyle = `rgba(0,0,0,${intensity})`;
      ctx.fillRect(0,0,w,h);

      for(let i=0;i<drops.length;i++){
        const ch = charset[(Math.random()*charset.length)|0];
        const x = i * fontSize;
        const y = drops[i] * fontSize;

        const bright = 150 + ((Math.random()*105)|0);
        ctx.fillStyle = `rgba(0,${bright},90,.9)`;
        ctx.fillText(ch, x, y);

        if (y > h && Math.random() > 0.975) drops[i] = 0;
        else drops[i] += speed;
      }
      requestAnimationFrame(draw);
    }

    // -----------------------------
    // Web Audio (beeps)
    // -----------------------------
    let audioCtx = null, master = null;

    function initAudio(){
      if(audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      master = audioCtx.createGain();
      master.gain.value = 0.12;
      master.connect(audioCtx.destination);
    }

    function bleep(freq=660, dur=0.06){
      if(!audioCtx) return;
      const now = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "square";
      o.frequency.setValueAtTime(freq, now);

      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.85, now + 0.004);
      g.gain.exponentialRampToValueAtTime(0.0001, now + dur);

      const f = audioCtx.createBiquadFilter();
      f.type = "lowpass";
      f.frequency.setValueAtTime(2200, now);

      o.connect(f); f.connect(g); g.connect(master);
      o.start(now);
      o.stop(now + dur + 0.01);
    }

    function chirpOk(){
      bleep(740, 0.06);
      setTimeout(() => bleep(880, 0.06), 80);
    }

    function buzzBad(){
      bleep(260, 0.08);
      setTimeout(() => bleep(220, 0.08), 90);
    }

    // -----------------------------
    // Flash helpers
    // -----------------------------
    const flashBad = document.getElementById("flashBad");
    const flashOk  = document.getElementById("flashOk");

    function pulse(el){
      el.classList.remove("on");
      void el.offsetWidth; // restart animation
      el.classList.add("on");
    }

    // -----------------------------
    // Game UI refs
    // -----------------------------
    const grid = document.getElementById("grid");
    const toast = document.getElementById("toast");
    const lettersEl = document.getElementById("letters");
    const roundPill = document.getElementById("roundPill");
    const bar = document.getElementById("bar");
    const restartBtn = document.getElementById("restart");

    // -----------------------------
    // Simple stick-figure builder (SVG)
    // -----------------------------
    const svg = (content) => `
    <svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <g fill="none" stroke="rgba(229,231,235,.92)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round">
        ${content}
      </g>
    </svg>`;

    const NORMAL = [
      () => svg(`<circle cx="60" cy="20" r="10" />
              <path d="M60 30 L60 60" />
              <path d="M60 42 L40 52" /><path d="M60 42 L78 54" />
              <path d="M60 60 L46 86" /><path d="M60 60 L72 88" />`),

      () => svg(`<circle cx="60" cy="18" r="10" />
              <path d="M60 28 L58 62" />
              <path d="M58 40 L36 40" /><path d="M58 40 L82 34" />
              <path d="M58 62 L42 70" /><path d="M58 62 L70 92" />`),

      () => svg(`<circle cx="52" cy="20" r="10" />
              <path d="M52 30 L62 62" />
              <path d="M56 42 L34 58" /><path d="M58 44 L84 52" />
              <path d="M62 62 L44 92" /><path d="M62 62 L78 84" />`),

      () => svg(`<circle cx="60" cy="20" r="10" />
              <path d="M60 30 L60 58" />
              <path d="M60 40 L42 30" /><path d="M60 40 L78 30" />
              <path d="M60 58 L36 72" /><path d="M60 58 L82 74" />`),

      () => svg(`<circle cx="60" cy="20" r="10" />
              <path d="M60 30 L54 58" />
              <path d="M56 40 L34 30" /><path d="M56 40 L84 44" />
              <path d="M54 58 L46 92" /><path d="M54 58 L74 74" />`),

      () => svg(`<circle cx="66" cy="18" r="10" />
              <path d="M66 28 L58 58" />
              <path d="M62 40 L40 50" /><path d="M62 40 L84 58" />
              <path d="M58 58 L40 84" /><path d="M58 58 L70 92" />`),

      () => svg(`<circle cx="60" cy="20" r="10" />
              <path d="M60 30 L60 62" />
              <path d="M60 44 L34 46" /><path d="M60 44 L86 46" />
              <path d="M60 62 L52 92" /><path d="M60 62 L78 84" />`),

      () => svg(`<circle cx="56" cy="20" r="10" />
              <path d="M56 30 L64 60" />
              <path d="M60 44 L42 66" /><path d="M60 44 L86 40" />
              <path d="M64 60 L52 92" /><path d="M64 60 L84 80" />`),

      () => svg(`<circle cx="60" cy="18" r="10" />
              <path d="M60 28 L60 60" />
              <path d="M60 40 L48 60" /><path d="M60 40 L76 60" />
              <path d="M60 60 L44 80" /><path d="M60 60 L74 92" />`),

      () => svg(`<circle cx="60" cy="20" r="10" />
              <path d="M60 30 L60 54" />
              <path d="M60 38 L44 44" /><path d="M60 38 L78 54" />
              <path d="M60 54 L38 92" /><path d="M60 54 L84 86" />`),

      () => svg(`<circle cx="62" cy="20" r="10" />
              <path d="M62 30 L58 60" />
              <path d="M60 44 L40 34" /><path d="M60 44 L84 40" />
              <path d="M58 60 L48 92" /><path d="M58 60 L80 84" />`)
    ];

    const IMPOSSIBLE = [
      () => svg(`<circle cx="56" cy="90" r="10" />
              <path d="M60 30 L60 60" />
              <path d="M60 42 L40 52" /><path d="M60 42 L78 54" />
              <path d="M60 60 L46 86" /><path d="M60 60 L72 88" />`),

      () => svg(`<circle cx="60" cy="20" r="10" />
              <path d="M60 30 L60 52" />
              <path d="M60 40 L38 40" /><path d="M60 40 L82 34" />
              <path d="M60 20 L44 78" /><path d="M60 20 L74 84" />`),

      () => svg(`<circle cx="60" cy="20" r="10" />
              <path d="M60 30 L60 60" />
              <path d="M60 42 L44 36 L52 56" />
              <path d="M60 42 L82 34" />
              <path d="M60 60 L46 86" /><path d="M60 60 L72 88" />`),

      () => svg(`<circle cx="60" cy="20" r="10" />
              <path d="M60 30 L60 44" />
              <path d="M60 42 L40 52" /><path d="M60 42 L78 54" />
              <path d="M60 64 L46 86" /><path d="M60 64 L72 88" />
              <path d="M60 46 L60 52" />`),

      () => svg(`<circle cx="60" cy="20" r="10" />
              <path d="M60 30 L60 60" />
              <path d="M46 86 L30 68" /><path d="M72 88 L92 70" />
              <path d="M60 60 L46 86" /><path d="M60 60 L72 88" />`)
    ];

    const TARGET = ["J","O","H","A","N"];

    const rounds = TARGET.map((letter, idx) => {
      const impossible = IMPOSSIBLE[idx];
      const normals = [];
      for (let i=0;i<11;i++) normals.push(NORMAL[(idx*3 + i) % NORMAL.length]);
      const options = normals.map(fn => ({ kind:"normal", svg: fn() }));
      options.push({ kind:"impossible", svg: impossible() });
      return { letter, options };
    });

    // Deterministic shuffle
    function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }
    function shuffle(arr, seed){
      const rnd = mulberry32(seed);
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(rnd()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    let round = 0;
    let solved = Array(5).fill("_");
    let locked = true; // locked until START pressed

    function render(){
      roundPill.textContent = `Ronde ${round+1}/5`;
      bar.style.width = `${(round/5)*100}%`;
      lettersEl.textContent = solved.join(" ");
      toast.className = "toast";
      toast.textContent = "Selecteer het onmogelijk silhouet.";
      grid.innerHTML = "";

      const opts = shuffle(rounds[round].options, 1000 + round*77);
      opts.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.className = "card";
        btn.type = "button";
        btn.setAttribute("aria-label", `Silhouet ${idx+1}`);
        btn.innerHTML = opt.svg;
        btn.disabled = locked;
        btn.addEventListener("click", () => choose(opt.kind === "impossible"));
        grid.appendChild(btn);
      });

      restartBtn.classList.add("hidden");
    }

    function setButtonsDisabled(disabled){
      [...grid.querySelectorAll("button.card")].forEach(b => b.disabled = disabled);
    }

    function choose(correct){
      if (locked) return;

      if (!correct){
        pulse(flashBad);
        buzzBad();
        toast.className = "toast bad";
        toast.textContent = "Niet mogelijk? Kijk naar anatomie en zwaartepunt. Probeer opnieuw.";
        return;
      }

      locked = true;
      setButtonsDisabled(true);

      pulse(flashOk);
      chirpOk();

      const letter = rounds[round].letter;
      solved[round] = letter;
      lettersEl.textContent = solved.join(" ");

      toast.className = "toast ok";
      toast.textContent = `Correct. Letter ontgrendeld: ${letter}`;

      setTimeout(() => {
        round++;
        locked = false;

        if (round >= 5){
          bar.style.width = "100%";
          toast.className = "toast ok";
          toast.textContent = `Codenaam bevestigd: ${TARGET.join("")} ✅`;
          restartBtn.classList.remove("hidden");
          restartBtn.onclick = () => {
            round = 0;
            solved = Array(5).fill("_");
            locked = false;
            render();
          };
          setButtonsDisabled(true);
          return;
        }
        render();
      }, 900);
    }

    // -----------------------------
    // START flow
    // -----------------------------
    const startOverlay = document.getElementById("startOverlay");
    const startBtn = document.getElementById("startBtn");

    startBtn.addEventListener("click", async () => {
      initAudio();
      if(audioCtx && audioCtx.state === "suspended") await audioCtx.resume();

      // start matrix
      running = true;
      requestAnimationFrame(draw);

      // small boot chirp
      bleep(520, 0.06);
      setTimeout(() => bleep(660, 0.06), 90);

      // unlock gameplay
      locked = false;
      startOverlay.remove();
      render();
    });

    // initial render (locked)
    render();
  })();
</script>
</body>
</html>
